## CDN原理

### CDN概念

CDN全称叫做“**Content Delivery Network**”，中文叫做**内容分发网络**。

实际上CDN这个概念是在1996年由美国麻省理工学院的一个研究小组为**改善互联网的服务质量**而提出的。

### 原理分析

当使用域名访问一个网站的时候，实际上就是把请求包（以Http请求为例）通过网络传输给某台服务器，比如访问“www.baidu.com“：

1. 首先解析出该域名对应的IP地址（DNS域名解析）。
2. 然后将HTTP请求包通过网络路由到IP地址所对应的服务器。
3. 我们通常说“服务器的IP地址”，这其实不太准确，IP地址是和网卡绑定的，一个服务器可以有多个网卡，也就是可能有多个IP地址。

#### 域名解析

解析域名分为两种：

1. 将一个域名解析为一个IP地址。
2. 将一个域名解析为另外一个域名。

在域名服务商购买了一个域名之后，需要去映射一个IP地址，可以用Map来表示这个关系：`{域名：IP}`。

也可以给某个域名取一个别名，比如“www.baidu.com”取一个别名“test.baidu.com”，这种关系也可以用Map来表示：`{域名：别名}`。这里的别名专业一点叫做**CNAME**。

而**域名解析**，实际上就是解析出指定域名所对应的IP地址，或者该域名的一个CNAME。

域名解析是有DNS系统来负责的，DNS接收外部请求，从请求里提取域名，如果这个域名对应的是IP地址，则返回这个IP地址，如果这个域名对应的是**CNAME**。则继续查找**CNAME**对应的IP地址，返回IP地址。

请求发送者拿到IP地址之后，完成真正的请求调用。

没有CNAME的情况：

![DNS解析](https://cdn.jsdelivr.net/gh/hanmlian/image-hosting@master/CDN/DNS解析.61rmdqjs3j80.jpg)

有CNAME的情况：

![CNAME的域名解析](https://cdn.jsdelivr.net/gh/hanmlian/image-hosting@master/CDN/CNAME的域名解析.1ok3vjszx22o.jpg)

**特别注意：在有CNAME的情况下，可以发现，CNAME实际上在域名解析过程中承担了中间人（代理）的角色，这是CDN实现的关键。**

#### CDN原理

首先**CDN**是为了**改善互联网的服务质量**。通俗一点就是提高访问速度。

假设现在百度只有一台服务器，现在有一个人在上海访问百度，如果该服务器也在上海，那么通常来说是访问比较快的。如果该服务器在拉萨，那么相对而言访问就比较慢了。这个问题的根本原因是网络传输是依赖于网线的（也可以是无线的），网线越长（距离越远），时间就越久。

那么怎么解决这个问题呢？其实思路很简单，**百度在全国各地都部署一模一样的服务器就行了，专业一点叫冗余。**

思路很简单，但实现还是比较麻烦的，服务器上的资源分为两种：**静态资源**与**动态资源**。

- **静态资源：**这种资源通常是很少变动的，比如图片，视频，css和	javascript等等。
- **动态资源：**这种资源不同用户不同时刻访问通常是不一样的，比如ftl，jsp等等。

如果百度要在全国各地都部署服务器，如果说每个服务器上都有相同的动态资源，可能还需要配置相应的数据库，因为动态资源所记录的信息通常会存储在数据库中，这就涉及到了数据同步等等问题，这会导致成本很高，这种做法专业一点其实就是**集群，**而目前来说集群架构最多是**三地五中心，**不是说全国多地集群不可能，主要是成本太高。

成本较低的方式，就是在服务器上只部署静态资源，静态资源通常不涉及到数据库，成本也比较低，也能提高用户的访问速度。

到这里，介绍了CDN想要达到的目的，那么怎么达到这个目的呢?

现在如果要比较CDN系统，我们可以考虑两点：

1. CDN系统中存储静态资源服务器的性能和网速怎么样。
2. CDN系统中全国甚至全球范围内服务器节点的数量以及部署情况。

如果静态资源的服务器节点很多，能够让用户在访问这些静态资源时，都不需要经过很远的距离就能获取到，这自然是CDN系统的优点。

现在的问题是用户在访问静态资源时也是通过域名来访问的，域名会被解析成一个IP地址，关键的问题是**CDN系统在做域名解析时，怎么保证解析出来一个离用户最近的IP地址呢**

普通的DNS服务器是做不到的，需要一个特殊的DNS服务器，这个特殊的DNS服务器需要知道

1. 用户当前所在位置。
2. 用户当前访问的域名对应哪些IP地址，以及这个IP地址分别在哪。

第一个问题非常好解决，从用户的请求中直接提取出用户的IP地址。

第二个问题由CDN提供商解决，CDN提供商肯定知道他们公司在哪些地方部署了机器以及它们的IP地址，**CDN提供商会提供这个特殊的DNS服务器，我们叫做 CDN专用DNS服务器**。

只要用户在使用某个域名访问静态资源时，如果用户直接配置自己电脑的**DNS地址为CDN专用DNS服务器**。那么自然解决了问题，但是我们需要考虑的时，我们不能要求世界上所有的用户都去修改自己电脑的DNS地址。所以这个时候就要利用DNS中的CNAME了。

用户使用某个域名来访问静态资源时（这个域名在阿里CDN服务中叫做“加速域名”），比如这个域名为“image.baidu.com”，它对应一个CNAME，叫做“cdn.ali.com”，普通的DNS服务器（区别**CDN专用DNS服务器**）在解析“image.baidu.com”会先解析成“cdn.ali.com”，普通DNS服务器发现该域名对应的也是一个DNS服务器，会将域名解析工作转交给该DNS服务器。

该DNS服务器就是**CDN专用DNS服务器。CDN专用DNS服务器**对“cdn.ali.com”进行解析，然后依据服务器上记录的所有CDN服务器地址信息，选出一个离用户最近的一个CDN服务器地址，并返回给用户，用户即可访问离自己最近的一台CDN服务器了。

![CDN原理](https://cdn.jsdelivr.net/gh/hanmlian/image-hosting@master/CDN/CDN原理.15hwtzs2e9xc.jpg)

